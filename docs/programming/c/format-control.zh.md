# C 语言格式说明符详细指南

格式说明符（也称为转换说明符）是 C 语言中用于控制输入输出函数（如 `printf` 和 `scanf`）行为的特殊字符序列。它们决定了数据如何被转换为字符串输出，或如何从输入字符串解析为程序中的变量。本指南将帮助你系统掌握这些关键工具的使用方法。

## 目录

1. [基本格式说明符](#基本格式说明符)
2. [printf 中的格式说明符](#printf中的格式说明符)
3. [scanf 中的格式说明符](#scanf中的格式说明符)
4. [标志、宽度、精度和长度修饰符](#标志宽度精度和长度修饰符)
5. [示例和最佳实践](#示例和最佳实践)

## 基本格式说明符

最常用的基本格式说明符包括：

- `%d`：有符号十进制整数
- `%f`：浮点数
- `%c`：单个字符
- `%s`：字符串
- `%p`：指针地址

虽然这些说明符在 `printf` 和 `scanf` 中都使用相同的符号，但它们在输入和输出场景中的行为存在重要差异。理解这些差异是正确使用格式化 I/O 的关键。

## printf中的格式说明符

`printf` 函数使用格式说明符来控制输出的显示方式。以下是详细说明：

### 1. 整数类型

- `%d`, `%i`：有符号十进制整数（两者功能相同）
- `%u`：无符号十进制整数
- `%o`：无符号八进制整数
- `%x`, `%X`：无符号十六进制整数（分别使用小写和大写字母）

示例：

```c
int num = 42;
printf("%d\n", num);  // 输出: 42
printf("%#x\n", num); // 输出: 0x2a（添加0x前缀）
```

> **提示**：使用 `#` 标志可以为八进制和十六进制输出添加前缀（0 或 0x/0X）。

### 2. 浮点类型

- `%f`：十进制浮点数（默认保留6位小数）
- `%e`, `%E`：科学记数法（分别使用小写和大写 e）
- `%g`, `%G`：根据数值大小自动选择 %f 或 %e 格式

示例：

```c
double pi = 3.1415926535;
printf("%f\n", pi);    // 输出: 3.141593
printf("%.2f\n", pi);  // 输出: 3.14（保留2位小数）
printf("%e\n", pi);    // 输出: 3.141593e+00
```

### 3. 字符和字符串

- `%c`：单个字符
- `%s`：字符串（自动在遇到空字符时停止）

示例：

```c
char ch = 'A';
char str[] = "Hello, World!";
printf("字符: %c\n", ch);   // 输出: 字符: A
printf("字符串: %s\n", str); // 输出: 字符串: Hello, World!
```

### 4. 指针

- `%p`：以十六进制格式输出指针地址

示例：

```c
int num = 10;
printf("地址: %p\n", (void *)&num); // 输出: 地址: 0x7ffd5e7e9e44（具体值因系统而异）
```

> **重要提示**：使用 `%p` 时，应将指针强制转换为 `void*` 类型，以确保跨平台兼容性。

## scanf中的格式说明符

`scanf` 函数使用格式说明符来解析输入数据。与 `printf` 相比，`scanf` 的格式说明符有其独特之处：

### 1. 整数类型

- `%d`, `%i`：有符号整数（`%i` 可自动识别八进制和十六进制前缀）
- `%u`：无符号十进制整数
- `%o`：无符号八进制整数
- `%x`, `%X`：无符号十六进制整数

示例：

```c
int num;
printf("请输入一个整数: ");
scanf("%d", &num);  // 用户输入 42
```

> **注意**：`%i` 能识别前缀（如 0 表示八进制，0x 表示十六进制），而 `%d` 仅识别十进制。

### 2. 浮点类型

- `%f`, `%e`, `%E`, `%g`, `%G`：在 `scanf` 中功能完全相同，通常使用 `%f` 即可

示例：

```c
float f;
printf("请输入一个浮点数: ");
scanf("%f", &f);  // 用户输入 3.14
```

### 3. 字符和字符串

- `%c`：读取单个字符（包括空白字符）
- `%s`：读取非空白字符序列（自动在末尾添加空字符）

示例：

```c
char ch;
char name[50];

printf("请输入一个字符: ");
scanf(" %c", &ch);  // 注意空格：跳过前导空白字符

printf("请输入您的名字: ");
scanf("%49s", name); // 限制输入长度，防止缓冲区溢出
```

> **关键提示**：`%c` 前的空格至关重要，它会跳过输入中任何前导空白字符（包括前一次输入遗留的换行符），避免将意外字符读入变量。

### 4. 特殊用法

- `%*`：跳过输入项（不存储到变量）
- `%n`：记录已处理的字符数（仅用于 `printf`）

示例：

```c
int a, b;
printf("请输入两个数字，中间用任意字符分隔: ");
scanf("%d%*c%d", &a, &b);  // 跳过两个数字之间的单个字符
```

## 标志、宽度、精度和长度修饰符

格式说明符可以包含额外的修饰元素，提供更精细的控制：

### 1. 标志（仅用于 `printf`）

- `-`：左对齐（默认右对齐）
- `+`：始终显示符号（正数也显示 +）
- 空格：正数前添加空格
- `0`：用零填充（与宽度结合使用）
- `#`：为八进制/十六进制添加前缀

### 2. 宽度

- 数字：指定最小字段宽度
- `*`：从参数列表中获取宽度值

### 3. 精度

- `.数字`：指定小数位数（浮点数）或最大字符数（字符串）
- `.*`：从参数列表中获取精度值

### 4. 长度修饰符

- `h`：`short` 或 `unsigned short`
- `l`：`long` 或 `unsigned long`
- `ll`：`long long` 或 `unsigned long long`
- `L`：`long double`

示例：

```c
printf("%+10.2f\n", 3.14159);  // 输出:     +3.14（右对齐，10字符宽，2位小数）
printf("%-10s\n", "Hello");     // 输出: Hello     （左对齐，10字符宽）
printf("%.*f\n", 3, 3.14159);  // 输出: 3.142（精度3从参数获取）
```

## 示例和最佳实践

### 1. 安全的输入处理

```c
char name[50];
int age;

printf("请输入姓名和年龄: ");
if (scanf("%49s %d", name, &age) == 2) {
    printf("姓名: %s, 年龄: %d\n", name, age);
} else {
    printf("输入格式错误，请重试\n");
    // 清除输入缓冲区
    while (getchar() != '\n');
}
```

> **为什么这样写**：`%49s` 限制输入长度，防止缓冲区溢出；检查 `scanf` 返回值确保输入有效；错误处理时清除输入缓冲区。

### 2. 精确控制输出格式

```c
printf("%-10s | %10s\n", "姓名", "分数");
printf("%-10s | %10.2f\n", "Alice", 92.5);
printf("%-10s | %10.2f\n", "Bob", 87.3);
```

输出效果：

```txt
姓名       |      分数
Alice      |      92.50
Bob        |      87.30
```

> **技巧**：使用 `-` 实现左对齐，结合固定宽度创建整齐的表格。

### 3. 动态格式控制

```c
int width = 15;
int precision = 3;
double value = 123.456789;

printf("动态格式: %*.*f\n", width, precision, value);
// 输出: 动态格式:        123.457
```

### 4. 处理大整数

```c
long long big_num = 9223372036854775807LL;
printf("大整数: %lld\n", big_num);
```

> **注意**：`long long` 类型必须使用 `%lld` 说明符，且字面量需添加 `LL` 后缀。

## 常见陷阱与解决方案

### 1. 格式说明符不匹配

**错误示例**：

```c
int num = 42;
printf("%f\n", num);  // 未定义行为！
```

**原因**：`%f` 期望 `double` 类型参数，但传入的是 `int`，导致栈数据被错误解释。

**正确做法**：

```c
printf("%d\n", num);  // 使用匹配的说明符
```

### 2. 缓冲区溢出风险

**危险示例**：

```c
char buffer[10];
scanf("%s", buffer);  // 用户输入过长会导致溢出
```

**安全方案**：

```c
scanf("%9s", buffer);  // 限制输入为9字符，保留1字符给结束符'\0'
```

### 3. 忽略输入函数的返回值

**错误示例**：

```c
int age;
scanf("%d", &age);  // 未检查输入是否成功
```

**健壮方案**：

```c
if (scanf("%d", &age) != 1) {
    printf("请输入有效的整数\n");
    // 清除错误状态和输入缓冲区
    while (getchar() != '\n');
    clearerr(stdin);
}
```

## 高级技巧

### 1. 使用 `fgets` + `sscanf` 安全读取

```c
char input[100];
printf("请输入您的信息: ");
if (fgets(input, sizeof(input), stdin) != NULL) {
    int age;
    if (sscanf(input, "%d", &age) == 1) {
        printf("年龄: %d\n", age);
    } else {
        printf("输入格式错误\n");
    }
}
```

> **优势**：`fgets` 会读取整行（包括换行符），避免输入残留；`sscanf` 在安全的字符串上进行解析。

### 2. 获取已输出字符数

```c
int chars_printed;
printf("Hello, %nWorld!\n", &chars_printed);
printf("已输出 %d 个字符\n", chars_printed);
```

> **注意**：`%n` 说明符在某些安全敏感环境中可能被禁用，使用时需谨慎。

### 3. 打印百分号

```c
printf("成绩: 95%%\n");  // 输出: 成绩: 95%
```

## 总结

掌握 C 语言的格式说明符是编写健壮程序的关键技能。通过本指南，你应该已经理解：

1. 基本格式说明符在 `printf` 和 `scanf` 中的异同
2. 如何使用标志、宽度、精度和长度修饰符精细控制 I/O
3. 常见陷阱及安全编程实践
4. 高级技巧提升代码质量和安全性

**最后建议**：在实际编程中，始终优先考虑输入安全性，养成检查函数返回值的习惯，并为字符串操作设置明确的长度限制。随着经验积累，这些格式说明符将成为你得心应手的工具。
